<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Select Dev User - Conductor Tool</title>
    <link rel="stylesheet" href="/css/components/global.css" />
    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }

      .dev-login-container {
        background: var(--color-white);
        border: var(--border-thick);
        padding: var(--space-2xl);
        max-width: 600px;
        width: 90%;
      }

      .dev-login-container h1 {
        text-align: center;
        margin-bottom: var(--space-xs);
      }

      .subtitle {
        text-align: center;
        color: var(--color-forest-green-medium);
        margin-bottom: var(--space-xl);
        font-size: var(--text-sm);
      }

      .user-list {
        max-height: 400px;
        overflow-y: auto;
        border: var(--border-thin);
        margin-bottom: var(--space-lg);
      }

      .user-item {
        padding: var(--space-md);
        border-bottom: var(--border-thin);
        cursor: pointer;
        transition: background-color var(--transition-fast);
        display: flex;
        align-items: center;
        gap: var(--space-md);
        background: var(--color-white);
      }

      .user-item:last-child {
        border-bottom: none;
      }

      .user-item:hover {
        background-color: var(--color-pale-mint);
      }

      .user-item.selected {
        background-color: var(--color-radioactive-lime);
        border-left: 4px solid var(--color-forest-green);
      }

      .user-avatar {
        width: 45px;
        height: 45px;
        background: var(--color-forest-green);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--color-radioactive-lime);
        font-weight: bold;
        font-size: var(--text-lg);
        flex-shrink: 0;
        border: var(--border-thin);
      }

      .user-info {
        flex: 1;
      }

      .user-name {
        font-weight: 600;
        color: var(--color-forest-green);
        margin-bottom: var(--space-xs);
        font-size: var(--text-base);
      }

      .user-email {
        font-size: var(--text-sm);
        color: var(--color-forest-green-medium);
      }

      .user-id {
        font-size: var(--text-xs);
        color: var(--color-gray);
        font-family: var(--font-mono);
        margin-top: 2px;
      }

      .login-button {
        width: 100%;
      }

      .login-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .loading {
        text-align: center;
        padding: var(--space-2xl);
        color: var(--color-forest-green-medium);
      }

      .error {
        background-color: #fee;
        border: 2px solid #f88;
        color: #c33;
        padding: var(--space-md);
        margin-bottom: var(--space-lg);
        text-align: center;
        font-weight: 600;
      }

      .search-box {
        margin-bottom: var(--space-md);
      }

      .search-box input {
        width: 100%;
        box-sizing: border-box;
      }

      .no-users {
        text-align: center;
        padding: var(--space-2xl);
        color: var(--color-gray);
      }
    </style>
  </head>
  <body class="animated-bg">
    <div class="dev-login-container">
      <h1>Development Login</h1>
      <p class="subtitle">Select a user from your local database</p>

      <div id="error-message" class="error" style="display: none"></div>

      <div class="search-box">
        <input
          type="text"
          id="search-input"
          placeholder="Search by name or email..."
        />
      </div>

      <div id="user-list-container">
        <div class="loading">Loading users...</div>
      </div>

      <button id="login-button" class="login-button" disabled>
        Login as Selected User
      </button>
    </div>

    <script>
      let allUsers = [];
      let selectedUserId = null;

      async function loadUsers() {
        try {
          const response = await fetch("/v1/api/auth/dev-users");
          if (!response.ok) {
            throw new Error("Failed to load users");
          }
          allUsers = await response.json();
          renderUsers(allUsers);
        } catch (error) {
          showError("Failed to load users: " + error.message);
          document.getElementById("user-list-container").innerHTML =
            '<div class="no-users">Failed to load users</div>';
        }
      }

      function renderUsers(users) {
        const container = document.getElementById("user-list-container");

        if (users.length === 0) {
          container.innerHTML =
            '<div class="no-users">No users found in database</div>';
          return;
        }

        const userList = document.createElement("div");
        userList.className = "user-list";

        users.forEach((user) => {
          const userItem = document.createElement("div");
          userItem.className = "user-item";
          userItem.dataset.userId = user.userUuid;

          const initials = getInitials(user.firstName, user.lastName);
          const fullName = `${user.firstName} ${user.lastName}`;

          userItem.innerHTML = `
            <div class="user-avatar">${initials}</div>
            <div class="user-info">
              <div class="user-name">${escapeHtml(fullName)}</div>
              <div class="user-email">${escapeHtml(user.email)}</div>
              <div class="user-id">${escapeHtml(user.userUuid)}</div>
            </div>
          `;

          userItem.addEventListener("click", () => selectUser(user.userUuid));
          userList.appendChild(userItem);
        });

        container.innerHTML = "";
        container.appendChild(userList);
      }

      function selectUser(userId) {
        selectedUserId = userId;

        // Update UI
        document.querySelectorAll(".user-item").forEach((item) => {
          if (item.dataset.userId === userId) {
            item.classList.add("selected");
          } else {
            item.classList.remove("selected");
          }
        });

        // Enable login button
        document.getElementById("login-button").disabled = false;
      }

      function getInitials(firstName, lastName) {
        const first = firstName ? firstName[0].toUpperCase() : "";
        const last = lastName ? lastName[0].toUpperCase() : "";
        return first + last || "?";
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function showError(message) {
        const errorDiv = document.getElementById("error-message");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
      }

      // Search functionality
      document
        .getElementById("search-input")
        .addEventListener("input", (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const filteredUsers = allUsers.filter(
            (user) =>
              user.firstName.toLowerCase().includes(searchTerm) ||
              user.lastName.toLowerCase().includes(searchTerm) ||
              user.email.toLowerCase().includes(searchTerm)
          );
          renderUsers(filteredUsers);

          // Reset selection if filtered out
          if (
            selectedUserId &&
            !filteredUsers.find((u) => u.userUuid === selectedUserId)
          ) {
            selectedUserId = null;
            document.getElementById("login-button").disabled = true;
          }
        });

      // Login button handler
      document
        .getElementById("login-button")
        .addEventListener("click", async () => {
          if (!selectedUserId) return;

          const button = document.getElementById("login-button");
          button.disabled = true;
          button.textContent = "Logging in...";

          try {
            const response = await fetch("/v1/api/auth/dev-login", {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify({ userId: selectedUserId })
            });

            if (!response.ok) {
              throw new Error("Login failed");
            }

            const data = await response.json();
            window.location.href = data.redirectUrl || "/dashboard";
          } catch (error) {
            showError("Login failed: " + error.message);
            button.disabled = false;
            button.textContent = "Login as Selected User";
          }
        });

      // Load users on page load
      loadUsers();
    </script>
  </body>
</html>
