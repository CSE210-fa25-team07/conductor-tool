// Prisma schema for Conductor Tool
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  roleUuid          String              @id @default(dbgenerated("gen_random_uuid()")) @map("role_uuid") @db.Uuid
  role              String              @unique @db.VarChar(50)
  
  courseEnrollments CourseEnrollment[]
  verificationCodes VerificationCode[]

  @@map("role")
}

model User {
  userUuid             String                  @id @default(dbgenerated("gen_random_uuid()")) @map("user_uuid") @db.Uuid
  email                String                  @unique @db.VarChar(255)
  firstName            String                  @map("first_name") @db.VarChar(100)
  lastName             String                  @map("last_name") @db.VarChar(100)
  photoUrl             String?                 @map("photo_url") @db.Text
  pronouns             String?                 @db.VarChar(50)
  bio                  String?                 @db.Text
  phoneNumber          String?                 @map("phone_number") @db.VarChar(20)
  githubUsername       String?                 @map("github_username") @db.VarChar(100)
  lastLogin            DateTime?               @map("last_login") @db.Timestamptz

  staff                Staff?
  courseEnrollments    CourseEnrollment[]
  createdMeetings      Meeting[]               @relation("MeetingCreator")
  participantMeetings  Participant[]
  teamsAsTa            Team[]                  @relation("TeamTA")
  teamMemberships      TeamMember[]
  standups             Standup[]
  standupComments      StandupComment[]
  sentNotifications    StandupNotification[]   @relation("NotificationSender")
  receivedNotifications StandupNotification[]  @relation("NotificationReceiver")

  @@map("users")
}

model Staff {
  userUuid          String   @id @map("user_uuid") @db.Uuid
  officeLocation    String?  @map("office_location") @db.VarChar(255)
  researchInterest  String?  @map("research_interest") @db.Text
  personalWebsite   String?  @map("personal_website") @db.Text
  isProf            Boolean  @default(false) @map("is_prof")
  isSystemAdmin     Boolean  @default(false) @map("is_system_admin")

  user              User     @relation(fields: [userUuid], references: [userUuid], onDelete: Cascade)

  @@map("staffs")
}

model ClassTerm {
  termUuid   String    @id @default(dbgenerated("gen_random_uuid()")) @map("term_uuid") @db.Uuid
  year       Int
  season     String    @db.VarChar(20)
  startDate  DateTime  @map("start_date") @db.Date
  endDate    DateTime  @map("end_date") @db.Date
  isActive   Boolean   @default(true) @map("is_active")

  courses    Course[]

  @@unique([year, season], name: "unique_term")
  @@map("class_term")
}

model Course {
  courseUuid       String                @id @default(dbgenerated("gen_random_uuid()")) @map("course_uuid") @db.Uuid
  courseCode       String                @map("course_code") @db.VarChar(20)
  courseName       String                @map("course_name") @db.VarChar(255)
  termUuid         String                @map("term_uuid") @db.Uuid
  description      String?               @db.Text
  syllabusUrl      String?               @map("syllabus_url") @db.Text
  canvasUrl        String?               @map("canvas_url") @db.Text
  lectureUuid      String?               @map("lecture_uuid") @db.Uuid

  term             ClassTerm             @relation(fields: [termUuid], references: [termUuid], onDelete: Cascade)
  enrollments      CourseEnrollment[]
  verificationCodes VerificationCode[]
  teams            Team[]
  meetings         Meeting[]
  standups         Standup[]

  @@unique([courseCode, termUuid], name: "unique_course_term")
  @@map("courses")
}

model CourseEnrollment {
  userUuid         String    @map("user_uuid") @db.Uuid
  courseUuid       String    @map("course_uuid") @db.Uuid
  roleUuid         String    @map("role_uuid") @db.Uuid
  enrollmentStatus String    @default("active") @map("enrollment_status") @db.VarChar(20)
  enrolledAt       DateTime? @map("enrolled_at") @db.Timestamptz
  droppedAt        DateTime? @map("dropped_at") @db.Timestamptz

  user             User      @relation(fields: [userUuid], references: [userUuid], onDelete: Cascade)
  course           Course    @relation(fields: [courseUuid], references: [courseUuid], onDelete: Cascade)
  role             Role      @relation(fields: [roleUuid], references: [roleUuid], onDelete: Restrict)

  @@id([userUuid, courseUuid, roleUuid])
  @@map("course_enrollment")
}

model VerificationCode {
  courseUuid  String   @map("course_uuid") @db.Uuid
  roleUuid    String   @map("role_uuid") @db.Uuid
  veriCode    String   @map("veri_code") @db.VarChar(100)
  isActive    Boolean  @default(true) @map("is_active")

  course      Course   @relation(fields: [courseUuid], references: [courseUuid], onDelete: Cascade)
  role        Role     @relation(fields: [roleUuid], references: [roleUuid], onDelete: Cascade)

  @@id([courseUuid, roleUuid])
  @@map("verification_codes")
}

model Team {
  teamUuid      String       @id @default(dbgenerated("gen_random_uuid()")) @map("team_uuid") @db.Uuid
  courseUuid    String       @map("course_uuid") @db.Uuid
  teamName      String       @map("team_name") @db.Text
  teamPageUrl   String?      @map("team_page_url") @db.Text
  repoUrl       String?      @map("repo_url") @db.Text
  teamTaUuid    String?      @map("team_ta_uuid") @db.Uuid

  course        Course       @relation(fields: [courseUuid], references: [courseUuid], onDelete: Restrict, onUpdate: Cascade)
  teamTa        User?        @relation("TeamTA", fields: [teamTaUuid], references: [userUuid], onDelete: SetNull, onUpdate: Cascade)
  members       TeamMember[]
  standups      Standup[]

  @@unique([courseUuid, teamName], name: "uq_team_name_per_course")
  @@map("teams")
}

model TeamMember {
  teamUuid  String    @map("team_uuid") @db.Uuid
  userUuid  String    @map("user_uuid") @db.Uuid
  joinedAt  DateTime  @default(now()) @map("joined_at") @db.Timestamptz
  leftAt    DateTime? @map("left_at") @db.Timestamptz

  team      Team      @relation(fields: [teamUuid], references: [teamUuid], onDelete: Cascade, onUpdate: Cascade)
  user      User      @relation(fields: [userUuid], references: [userUuid], onDelete: Cascade, onUpdate: Cascade)

  @@id([teamUuid, userUuid])
  @@map("team_members")
}

model Standup {
  standupUuid     String                 @id @default(dbgenerated("gen_random_uuid()")) @map("standup_uuid") @db.Uuid
  userUuid        String                 @map("user_uuid") @db.Uuid
  teamUuid        String                 @map("team_uuid") @db.Uuid
  courseUuid      String                 @map("course_uuid") @db.Uuid
  dateSubmitted   DateTime?              @map("date_submitted") @db.Timestamptz
  whatDone        String?                @map("what_done") @db.Text
  whatNext        String?                @map("what_next") @db.Text
  blockers        String?                @db.Text
  reflection      String?                @db.Text
  sentimentScore  Int?                   @map("sentiment_score")
  visibility      String?                @db.VarChar(20)
  createdAt       DateTime               @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime               @default(now()) @map("updated_at") @db.Timestamptz

  user            User                   @relation(fields: [userUuid], references: [userUuid], onDelete: Cascade)
  team            Team                   @relation(fields: [teamUuid], references: [teamUuid], onDelete: Cascade)
  course          Course                 @relation(fields: [courseUuid], references: [courseUuid], onDelete: Cascade)
  comments        StandupComment[]
  notifications   StandupNotification[]
  sentimentLogs   StandupSentimentLog[]

  @@map("standup")
}

model StandupComment {
  commentUuid    String   @id @default(dbgenerated("gen_random_uuid()")) @map("comment_uuid") @db.Uuid
  standupUuid    String   @map("standup_uuid") @db.Uuid
  commenterUuid  String   @map("commenter_uuid") @db.Uuid
  commentText    String   @map("comment_text") @db.Text
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime @default(now()) @map("updated_at") @db.Timestamptz

  standup        Standup  @relation(fields: [standupUuid], references: [standupUuid], onDelete: Cascade)
  commenter      User     @relation(fields: [commenterUuid], references: [userUuid], onDelete: Cascade)

  @@map("standup_comments")
}

model StandupNotification {
  notifUuid    String   @id @default(dbgenerated("gen_random_uuid()")) @map("notif_uuid") @db.Uuid
  senderUuid   String   @map("sender_uuid") @db.Uuid
  receiverUuid String   @map("receiver_uuid") @db.Uuid
  standupUuid  String   @map("standup_uuid") @db.Uuid
  message      String   @db.Text
  status       String   @db.VarChar(10)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz

  sender       User     @relation("NotificationSender", fields: [senderUuid], references: [userUuid], onDelete: Cascade)
  receiver     User     @relation("NotificationReceiver", fields: [receiverUuid], references: [userUuid], onDelete: Cascade)
  standup      Standup  @relation(fields: [standupUuid], references: [standupUuid], onDelete: Cascade)

  @@map("standup_notifications")
}

model StandupSentimentLog {
  logUuid        String   @id @default(dbgenerated("gen_random_uuid()")) @map("log_uuid") @db.Uuid
  standupUuid    String   @map("standup_uuid") @db.Uuid
  sentimentScore Int      @map("sentiment_score")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz

  standup        Standup  @relation(fields: [standupUuid], references: [standupUuid], onDelete: Cascade)

  @@map("standup_sentiment_logs")
}

model Meeting {
  meetingUuid        String        @id @default(dbgenerated("gen_random_uuid()")) @map("meeting_uuid") @db.Uuid
  creatorUuid        String        @map("creator_uuid") @db.Uuid
  courseUuid         String        @map("course_uuid") @db.Uuid
  meetingStartTime   DateTime      @map("meeting_start_time") @db.Timestamptz
  meetingEndTime     DateTime      @map("meeting_end_time") @db.Timestamptz
  meetingDate        DateTime      @map("meeting_date") @db.Date
  meetingTitle       String        @map("meeting_title") @db.VarChar(255)
  meetingDescription String?       @map("meeting_description") @db.Text
  meetingLocation    String?       @map("meeting_location") @db.VarChar(255)
  isRecurring        Boolean       @default(false) @map("is_recurring")
  parentMeetingUuid  String?       @map("parent_meeting_uuid") @db.Uuid
  meetingType        Int           @map("meeting_type")

  creator            User          @relation("MeetingCreator", fields: [creatorUuid], references: [userUuid], onDelete: Cascade)
  course             Course        @relation(fields: [courseUuid], references: [courseUuid], onDelete: Cascade)
  parentMeeting      Meeting?      @relation("RecurringMeetings", fields: [parentMeetingUuid], references: [meetingUuid], onDelete: SetNull)
  childMeetings      Meeting[]     @relation("RecurringMeetings")
  participants       Participant[]
  meetingCodes       MeetingCode[]

  @@map("meeting")
}

model Participant {
  meetingUuid      String    @map("meeting_uuid") @db.Uuid
  participantUuid  String    @map("participant_uuid") @db.Uuid
  present          Boolean   @default(false)
  attendanceTime   DateTime? @map("attendance_time") @db.Timestamptz

  meeting          Meeting   @relation(fields: [meetingUuid], references: [meetingUuid], onDelete: Cascade)
  participant      User      @relation(fields: [participantUuid], references: [userUuid], onDelete: Cascade)

  @@id([meetingUuid, participantUuid])
  @@map("participants")
}

model MeetingCode {
  codeUuid           String   @id @default(dbgenerated("gen_random_uuid()")) @map("code_uuid") @db.Uuid
  qrUrl              String   @map("qr_url") @db.Text
  meetingCode        String   @map("meeting_code") @db.VarChar(20)
  meetingUuid        String   @map("meeting_uuid") @db.Uuid
  validStartDatetime DateTime @map("valid_start_datetime") @db.Timestamptz
  validEndDatetime   DateTime @map("valid_end_datetime") @db.Timestamptz

  meeting            Meeting  @relation(fields: [meetingUuid], references: [meetingUuid], onDelete: Cascade)

  @@map("meeting_codes")
}
